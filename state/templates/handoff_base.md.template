# Stage Handoff: {{CURRENT_STAGE}} → {{NEXT_STAGE}}

**Created**: {{TIMESTAMP}}
**Creator**: {{PRIMARY_AI}}
**Duration**: {{DURATION}}

---

## AI Usage Log

> This section compares intended AI settings with actual usage to track collaboration efficiency.

### Intended vs Actual Comparison

| Item | Intended | Actual | Match |
|------|----------|--------|-------|
| Primary AI | {{INTENDED_PRIMARY_AI}} | {{ACTUAL_PRIMARY_AI}} | {{PRIMARY_MATCH}} |
| Secondary AI | {{INTENDED_SECONDARY_AI}} | {{ACTUAL_SECONDARY_AI}} | {{SECONDARY_MATCH}} |
| Collaboration Mode | {{INTENDED_COLLABORATION_MODE}} | {{ACTUAL_COLLABORATION_MODE}} | {{MODE_MATCH}} |
| External AI Call | {{INTENDED_EXTERNAL_CALL}} | {{ACTUAL_EXTERNAL_CALL}} | {{EXTERNAL_MATCH}} |

### Collaboration Mode Details

- **Configured Mode**: {{COLLABORATION_MODE}} (parallel/debate/sequential/none)
- **Actual Execution**: {{MODE_EXECUTED}} (Yes/No)
- **Reason for Non-Execution**: {{NON_EXECUTION_REASON}}

### AI Call Log

| AI | Call Time | Role | Prompt | Result | Status |
|----|-----------|------|--------|--------|--------|
{{#each AI_CALLS}}
| {{this.model}} | {{this.timestamp}} | {{this.role}} | {{this.prompt_file}} | {{this.output_file}} | {{this.status}} |
{{/each}}

### Fallback Log

| Attempted AI | Failure Time | Error | Fallback AI | Result |
|--------------|--------------|-------|-------------|--------|
{{#each FALLBACK_EVENTS}}
| {{this.attempted_model}} | {{this.failure_time}} | {{this.error}} | {{this.fallback_model}} | {{this.result}} |
{{/each}}

> Configuration: `config/ai_collaboration.yaml`, `config/mcp_fallbacks.yaml`

---

## Completed Tasks

{{#each COMPLETED_TASKS}}
- [x] {{this.name}} {{#if this.ai}}({{this.ai}}){{/if}}
{{/each}}

---

## Context for Next Agent

### Key Decisions

{{#each KEY_DECISIONS}}
- **{{this.topic}}**: {{this.decision}}
  - Rationale: {{this.rationale}}
  - Alternatives: {{this.alternatives}}
{{/each}}

### Modified Files

| File | Change Type | Lines Changed | Responsible AI |
|------|-------------|---------------|----------------|
{{#each MODIFIED_FILES}}
| `{{this.path}}` | {{this.change_type}} | {{this.lines_changed}} | {{this.ai_model}} |
{{/each}}

### Known Issues / Technical Debt

{{#each KNOWN_ISSUES}}
- **{{this.id}}**: {{this.description}}
  - Severity: {{this.severity}}
  - Status: {{this.status}}
{{/each}}

---

## Test Status (Test-First Flow)

> ⚠️ Verify that tests were run in this stage.

### Tests Run

| Test Type | Run Time | Result | Coverage |
|-----------|----------|--------|----------|
{{#each TESTS_RUN}}
| {{this.type}} | {{this.timestamp}} | {{this.result}} | {{this.coverage}} |
{{/each}}

### Smoke Test Results

- **`npm run dev` execution**: {{DEV_SERVER_STATUS}}
- **Basic functionality check**: {{BASIC_FUNCTIONALITY}}
- **Playwright smoke test**: {{PLAYWRIGHT_SMOKE}}

### Bugs Found

{{#each BUGS_FOUND}}
- **{{this.id}}**: {{this.description}}
  - Found at: {{this.found_at}}
  - Status: {{this.status}}
  - Fix file: {{this.fix_file}}
{{/each}}

---

## Checkpoint Information

| ID | Created | Description | Auto/Manual |
|----|---------|-------------|-------------|
{{#each CHECKPOINTS}}
| {{this.id}} | {{this.date}} | {{this.description}} | {{this.type}} |
{{/each}}

Recovery command:
```bash
scripts/restore-checkpoint.sh {{LATEST_CP_ID}}
```

---

## Generated Outputs

| File | Description | Validation Status |
|------|-------------|-------------------|
{{#each OUTPUTS}}
| {{this.path}} | {{this.description}} | {{this.validation_status}} |
{{/each}}

---

## {{NEXT_STAGE}} Stage Guide

### Immediate Tasks

{{#each IMMEDIATE_TASKS}}
{{this.order}}. {{this.task}}
{{/each}}

### Warnings

{{#each WARNINGS}}
- ⚠️ {{this}}
{{/each}}

### Reference Files

{{#each REFERENCE_FILES}}
- `{{this}}`
{{/each}}

---

---

## Epic Cycle Information

{{#if EPIC_CYCLE_ENABLED}}
| Property | Value |
|----------|-------|
| Current Cycle | {{CURRENT_CYCLE}} / {{TOTAL_CYCLES}} |
| Scope | {{SCOPE_START}} → {{SCOPE_END}} |
| Completed Cycles | {{COMPLETED_CYCLES}} |

### Previous Cycle Learnings
{{#if PREVIOUS_CYCLE_LEARNINGS}}
{{PREVIOUS_CYCLE_LEARNINGS}}
{{else}}
_First cycle - no previous learnings_
{{/if}}
{{else}}
_Epic cycles not enabled_
{{/if}}

---

## Implementation Order

{{#if IMPLEMENTATION_ORDER}}
| Property | Value |
|----------|-------|
| Selected Order | {{IMPLEMENTATION_ORDER}} |
| Current Phase | {{CURRENT_PHASE}} |
| Phase Name | {{PHASE_NAME}} |

### Reference Links
{{#each TECH_REFERENCE_LINKS}}
- [{{this.name}}]({{this.url}}) - {{this.description}}
{{/each}}
{{else}}
_Implementation order not yet selected_
{{/if}}

---

## Moodboard Analysis

{{#if MOODBOARD_ACTIVE}}
| Property | Value |
|----------|-------|
| Style | {{DESIGN_STYLE}} |
| Analysis Status | {{ANALYSIS_STATUS}} |
| Feedback Iterations | {{FEEDBACK_ITERATIONS}} |

### Collected Categories
{{#each MOODBOARD_CATEGORIES}}
- {{this.name}}: {{this.count}} images
{{/each}}

### Design Token Summary
{{#if DESIGN_TOKENS_GENERATED}}
- Colors: {{COLOR_COUNT}} defined
- Typography: {{TYPOGRAPHY_COUNT}} styles
- Spacing: {{SPACING_COUNT}} values
{{else}}
_Design tokens not yet generated_
{{/if}}
{{else}}
_Moodboard collection not active_
{{/if}}

---

## Requirements Refinement

{{#if REFINEMENT_ACTIVE}}
| Property | Value |
|----------|-------|
| Iteration | {{REFINEMENT_ITERATION}} |
| Refined Requirements | {{REFINED_COUNT}} |
| Validation Status | {{VALIDATION_STATUS}} |

### Refinement Summary
| Level | Count |
|-------|-------|
| Epics | {{EPIC_COUNT}} |
| Features | {{FEATURE_COUNT}} |
| Tasks | {{TASK_COUNT}} |
| Subtasks | {{SUBTASK_COUNT}} |

### Pending Refinement
{{#each PENDING_REFINEMENT}}
- {{this.requirement}} ({{this.level}})
{{/each}}
{{else}}
_No active refinement session_
{{/if}}

---

## Metadata

```yaml
stage: "{{CURRENT_STAGE}}"
status: "completed"
next_stage: "{{NEXT_STAGE}}"
timestamp: "{{TIMESTAMP}}"

ai_usage:
  intended:
    primary: "{{INTENDED_PRIMARY_AI}}"
    secondary: "{{INTENDED_SECONDARY_AI}}"
    collaboration_mode: "{{INTENDED_COLLABORATION_MODE}}"
  actual:
    primary: "{{ACTUAL_PRIMARY_AI}}"
    secondary: "{{ACTUAL_SECONDARY_AI}}"
    collaboration_mode: "{{ACTUAL_COLLABORATION_MODE}}"
  fallbacks: {{FALLBACK_COUNT}}
  match_rate: "{{MATCH_RATE}}"

testing:
  smoke_test_run: {{SMOKE_TEST_RUN}}
  bugs_found: {{BUGS_FOUND_COUNT}}
  bugs_fixed: {{BUGS_FIXED_COUNT}}

# Advanced Features
epic_cycle:
  enabled: {{EPIC_CYCLE_ENABLED}}
  current: {{CURRENT_CYCLE}}
  total: {{TOTAL_CYCLES}}
  scope: "{{SCOPE_START}} -> {{SCOPE_END}}"

implementation_order:
  selected: "{{IMPLEMENTATION_ORDER}}"
  phase: {{CURRENT_PHASE}}

moodboard:
  active: {{MOODBOARD_ACTIVE}}
  iterations: {{FEEDBACK_ITERATIONS}}
  tokens_generated: {{DESIGN_TOKENS_GENERATED}}

refinement:
  active: {{REFINEMENT_ACTIVE}}
  iteration: {{REFINEMENT_ITERATION}}
  validated: {{VALIDATION_STATUS}}

checkpoint_id: "{{LATEST_CP_ID}}"
files_modified: {{FILE_COUNT}}
```
