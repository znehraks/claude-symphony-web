// MCP Fallback Configuration
{
  "mcp_fallbacks": {
    "enabled": true,
    "triggers": [
      "quota_exceeded",
      "service_unavailable",
      "timeout",
      "rate_limited"
    ]
  },
  "search": {
    "code_documentation": {
      "primary": "context7",
      "fallbacks": [
        "exa",
        "web_search"
      ],
      "rules": {
        "on_quota_exceeded": "use_fallback",
        "on_timeout": "retry_then_fallback",
        "retry_count": 2,
        "retry_delay_ms": 1000
      }
    },
    "web_search": {
      "primary": "exa",
      "fallbacks": [
        "web_search"
      ],
      "rules": {
        "on_quota_exceeded": "use_fallback",
        "on_timeout": "use_fallback"
      }
    },
    "community": {
      "primary": "exa",
      "fallbacks": [
        "web_search"
      ],
      "settings": {
        "include_domains": [
          "reddit.com",
          "news.ycombinator.com",
          "dev.to",
          "stackoverflow.com"
        ]
      }
    }
  },
  "browser": {
    "primary": "playwright",
    "fallbacks": [
      "chrome-devtools"
    ],
    "rules": {
      "on_connection_failed": "use_fallback"
    }
  },
  "notion": {
    "primary": "notion",
    "fallbacks": [
      "json_file"
    ],
    "json_fallback": {
      "enabled": true,
      "description": "Local JSON file fallback when Notion MCP is unavailable",
      "file_path": "state/tasks.json",
      "schema": {
        "version": "1.0",
        "structure": {
          "epics": [
            {
              "id": "string",
              "title": "string",
              "status": "pending|in_progress|completed",
              "features": "array<feature>"
            }
          ],
          "features": [
            {
              "id": "string",
              "epic_id": "string",
              "title": "string",
              "status": "pending|in_progress|completed",
              "tasks": "array<task>"
            }
          ],
          "tasks": [
            {
              "id": "string",
              "feature_id": "string",
              "title": "string",
              "description": "string",
              "status": "pending|in_progress|completed",
              "priority": "P0|P1|P2|P3",
              "estimate_hours": "number",
              "blocked_by": "array<task_id>",
              "blocks": "array<task_id>",
              "assignee": "string|null",
              "sprint": "string|null"
            }
          ]
        }
      },
      "sync": {
        "on_notion_available": "merge",
        "conflict_resolution": "notion_wins",
        "auto_sync_interval": null
      },
      "operations": {
        "create_task": true,
        "update_task": true,
        "delete_task": true,
        "query_tasks": true,
        "create_epic": true,
        "create_feature": true,
        "update_dependencies": true
      }
    },
    "on_error": {
      "action": "use_json_fallback",
      "message": "Notion connection failed. Using local JSON file (state/tasks.json) as fallback.",
      "notify_user": true
    }
  },
  "figma": {
    "primary": "figma-dev-mode",
    "fallbacks": [],
    "on_error": {
      "action": "notify_user",
      "message": "Figma connection failed. Check Dev Mode MCP settings."
    }
  },
  "stitch": {
    "primary": "stitch",
    "fallbacks": ["figma-dev-mode", "claude_vision"],
    "rules": {
      "on_quota_exceeded": "use_fallback",
      "on_timeout": "retry_then_fallback",
      "retry_count": 2,
      "retry_delay_ms": 2000
    },
    "quota_management": {
      "standard_limit": 350,
      "experimental_limit": 50,
      "reset_period": "monthly",
      "warning_threshold_percent": 80
    },
    "on_error": {
      "action": "use_fallback_chain",
      "message": "Stitch MCP unavailable. Falling back to {{FALLBACK_TOOL}}."
    }
  },
  "stage_preferences": {
    "01-brainstorm": {
      "search": [
        "exa",
        "web_search"
      ],
      "reason": "Exa preferred for community/idea search"
    },
    "02-research": {
      "search": [
        "context7",
        "exa",
        "web_search"
      ],
      "reason": "Context7 preferred for technical documentation search"
    },
    "03-planning": {
      "search": [
        "context7",
        "exa"
      ],
      "reason": "Architecture pattern/documentation search"
    },
    "04-ui-ux": {
      "ui_generation": ["stitch", "figma-dev-mode", "claude_vision"],
      "browser": [
        "figma-dev-mode",
        "playwright"
      ],
      "search": [
        "exa",
        "web_search"
      ],
      "reason": "Stitch for UI generation, Figma for design tokens"
    },
    "06-implementation": {
      "search": [
        "context7"
      ],
      "reason": "Context7 required for library documentation search"
    },
    "09-testing": {
      "browser": [
        "playwright",
        "chrome-devtools"
      ],
      "reason": "Playwright required for E2E testing"
    }
  },
  "monitoring": {
    "quota_warning": {
      "threshold_percent": 80,
      "action": "warn_user"
    },
    "usage_logging": {
      "enabled": true,
      "log_file": "state/mcp_usage.log"
    }
  },
  "error_handling": {
    "all_fallbacks_failed": {
      "action": "notify_user_and_continue",
      "message": "All MCP search tools have failed.\n- Proceed with manual search or\n- Check MCP server status.\n"
    },
    "fatal_error": {
      "action": "save_state_and_notify",
      "message": "MCP fatal error. Save state and restart session."
    }
  },
  "ai_model_fallbacks": {
    "enabled": true,
    "description": "Auto-fallback to ClaudeCode when external AI CLI fails",
    "triggers": [
      "cli_not_installed",
      "authentication_failed",
      "api_timeout",
      "rate_limited",
      "service_error"
    ],
    "stage_fallbacks": {
      "01-brainstorm": {
        "primary": "gemini",
        "fallback": "claudecode",
        "fallback_reason_template": "Gemini CLI call failed: {{ERROR}} - Fallback to ClaudeCode"
      },
      "03-planning": {
        "primary": "gemini",
        "fallback": "claudecode",
        "fallback_reason_template": "Gemini CLI call failed: {{ERROR}} - Fallback to ClaudeCode"
      },
      "04-ui-ux": {
        "primary": "gemini",
        "fallback": "claudecode",
        "fallback_reason_template": "Gemini CLI call failed: {{ERROR}} - Fallback to ClaudeCode"
      },
      "07-refactoring": {
        "primary": "codex",
        "fallback": "claudecode",
        "fallback_reason_template": "Codex CLI call failed: {{ERROR}} - Fallback to ClaudeCode"
      },
      "09-testing": {
        "primary": "codex",
        "fallback": "claudecode",
        "fallback_reason_template": "Codex CLI call failed: {{ERROR}} - Fallback to ClaudeCode"
      }
    },
    "behavior": {
      "auto_fallback": true,
      "retry": {
        "enabled": true,
        "max_attempts": 2,
        "delay_ms": 3000
      },
      "show_warning_before_fallback": true,
      "warning_message": "External AI {{PRIMARY_MODEL}} call failed\n- Error: {{ERROR_MESSAGE}}\n- Fallback: Continuing with {{FALLBACK_MODEL}}\n"
    },
    "logging": {
      "enabled": true,
      "log_file": "state/ai_fallback.log",
      "include_in_handoff": true,
      "format": {
        "timestamp": true,
        "stage": true,
        "intended_model": true,
        "fallback_model": true,
        "error_reason": true,
        "result": true
      },
      "handoff_template": "### Fallback Log\n\n| Attempted AI | Failure Time | Error | Fallback AI | Result |\n|--------------|--------------|-------|-------------|--------|\n{{#each FALLBACK_EVENTS}}\n| {{this.attempted_model}} | {{this.failure_time}} | {{this.error}} | {{this.fallback_model}} | {{this.result}} |\n{{/each}}\n"
    }
  },
  "pre_run_check": {
    "enabled": true,
    "script": "scripts/pre-run-check.sh",
    "checks": [
      {
        "name": "gemini_cli",
        "command": "which gemini",
        "on_failure": "warn",
        "message": "Gemini CLI not installed - ClaudeCode fallback expected for stages 01, 03, 04"
      },
      {
        "name": "codex_cli",
        "command": "which codex",
        "on_failure": "warn",
        "message": "Codex CLI not installed - ClaudeCode fallback expected for stages 07, 09"
      },
      {
        "name": "tmux",
        "command": "which tmux",
        "on_failure": "error",
        "message": "tmux not installed - External AI calls not possible"
      },
      {
        "name": "gemini_wrapper",
        "command": "test -x scripts/gemini-wrapper.sh",
        "on_failure": "warn",
        "message": "gemini-wrapper.sh not executable"
      },
      {
        "name": "codex_wrapper",
        "command": "test -x scripts/codex-wrapper.sh",
        "on_failure": "warn",
        "message": "codex-wrapper.sh not executable"
      },
      {
        "name": "stitch_mcp",
        "command": "claude mcp list | grep -q stitch",
        "on_failure": "warn",
        "message": "Stitch MCP not configured. Run: scripts/setup-stitch-mcp.sh"
      },
      {
        "name": "gcloud_auth",
        "command": "gcloud auth print-access-token &> /dev/null 2>&1",
        "on_failure": "warn",
        "message": "Google Cloud not authenticated. Run: gcloud auth login"
      }
    ]
  }
}